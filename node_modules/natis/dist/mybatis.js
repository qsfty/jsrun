!(function(){
	var mysql = require('mysql');
	var Promise = require('bluebird');
	var mybatis = {};
	var defaults = {
		'mapper' : '/database/mapper',
		'settings' : require('../config/settings'),
		'validate' : require('../config/validate')
	}
	var connection;
	var pool = {};
	mybatis.config = function(name,value){
		defaults[name] = value;
	}

	mybatis.init = function(cb){
		if(connection){
			if(cb){
				return cb(null,connection)
			}
			return;
		}
		var db = mysql.createConnection(defaults.settings.connection())
		db.connect(function(err){
			if(err){
				throw new Error("数据库连接失败")
			}
			connection = db
			db.models = {}

			var connName = generate();
			db.connName = connName;
			require('./init')(db,defaults);
			if(cb){
				return cb(null,db)
			}
		})
	}

	mybatis.connect = function(config,cb){
		return new Promise(function(resolve,reject){
			if(config && config['connName'] && pool[config['connName']]){
				return resolve(pool[config['connName']]);
			}
			var db = mysql.createConnection(config)
			db.connect(function(err){
				if(err){
					return reject('数据库连接失败');
				}
				if(config['connName']){
					pool[config['connName']] = db;
				}
				db.models = {}
				db.connName = config['connName'];
				require('./init')(db,config.other);
				resolve(db);
			})
		});
	}

	mybatis.use = function(cb){
		mybatis.init(cb);
	}

	mybatis.db = function(){
		return connection;
	}

	function generate(){
		var a = [];
		for(var i=0;i<8;i++){
			a.push((Math.floor)(Math.random() * 10));
		}
		return 'conn' + a.join('');
	}
	module.exports = mybatis;
})();